<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.css" crossorigin="anonymous">
    <title>Redemption Form</title>
    <style>
      body {
        background-color: #17061B;
        color: #ccc;
      }
      table {
        width: 100%;
      }
      input {
        border: none;
      }
      .main {
        background-color: #290B32;
        padding-bottom: 15px;
      }
      pre {
        white-space: pre-wrap;
        word-break: normal;
      }
      .alert {
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <div class="container main">
    <h1>Token Redemption Form</h1>
      <div class="alert alert-warning">
        Make sure all information here matches the identification you will provide to the Tokenizer. If you are not sure what identification the Tokenizer will accept, please contact them directly.
      </div>
      <form id="identification-form" onsubmit="generateRedemptionCode(event)">
        <table class="table">
          <tr>
            <td>Token Id</td>
            <td>
              <input name="tokenId" id="tokenId" class="form-control" type="number" min="0" required>
              <br/>
              <div class="alert alert-warning">
                Make sure this is the correct token id for the token you're attempting to redeem.
              </div>
            </td>
          </tr>
          <tr>
            <td>Birth Year (YYYY)</td>
            <td><input name="birthYearAscii" class="form-control" type="number" required min="1900" max="2000"></td>
          </tr>
          <tr>
            <td>Birth Month (MM)</td>
            <td><input name="birthMonthAscii" class="form-control" type="number" required min="1" max="12"></td>
          </tr>
          <tr>
            <td>Birth Day (DD)</td>
            <td><input name="birthDayAscii" class="form-control" type="number" required min="1" max="31"></td>
          </tr>
          <tr>
            <td>Last Name</td>
            <td><input name="lastNameAscii" class="form-control" type="text" required></td>
          </tr>
          <tr>
            <td>First Name</td>
            <td><input name="firstNameAscii" class="form-control" type="text" required></td>
          </tr>
          <tr>
            <td></td>
            <td>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="" id="tos" required>
                <label class="form-check-label" for="tos">
                  I agree to the <a href="./tos.html" target="_blank">Terms of Service</a>.
                </label>
              </div>
            </td>
          </tr>
        </table>
        <button class="btn btn-default pull-right">Generate Redemption Code</button>
        <div style="clear:both"></div>
      </form>
      <div id="redemption-code" style="display:none">
        <hr/>
        <h4>Redemption Code Information</h4>
        <div class="alert alert-warning">
          <ul>
            <li>
              This information is not saved on our server. Save a copy on your computer and back it up somewhere.
            </li>
            <li>
              You will not need to provide this information to the Tokenizer when redeeming the asset.
            </li>
            <li>
              If you submit the Redemption Code Hash to the network and lose the Redemption Code, you may not be able to recover the tokenized asset.
            </li>
          </ul>
        </div>
        <div class = "panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title" id="file-name"></h3>
            <div style="clear:both"></div>
          </div>
          <div class = "panel-body">
            <pre id="redemption-code-txt" class="pre"></pre>
          </div>
          <div class="panel-footer">
            <div class="btn-group pull-right">
                <a id="redemption-code-txt-download" class="btn btn-primary">Download</a>
            </div>
            <div style="clear:both"></div>
          </div>
      </div>
        <hr/>
        <label>
          <input type="checkbox" id="redemption-code-checkbox">
          I have saved a copy of my Redemption Code Information and backed it up.
        </label>
        <br/>
        <button class="btn btn-default" disabled>Submit Redemption Code Hash & Destroy Token</button>
      </div>
    </div>
    <script type="module" src="./lib/redeemer.js"></script>
    <script type="module" src="./lib/base2048.js"></script>
    <script type="text/javascript">

      if(document.location.hash) {
        document.getElementById('tokenId').value = document.location.hash.substr(1)
      }


      $identificationForm = document.getElementById('identification-form')
      $redemptionCode = document.getElementById('redemption-code')
      $redemptionCodeTxt = document.getElementById('redemption-code-txt')
      $redemptionCodeTxtDownload = document.getElementById('redemption-code-txt-download')
      $fileName = document.getElementById('file-name')

      function zeroPadAscii(ascii, length) {
        return `${'0'.repeat(length - ascii.length)}${ascii}`
      }

      const fields = ['birthYearAscii', 'birthMonthAscii', 'birthDayAscii', 'lastNameAscii', 'firstNameAscii']
      const divider = '\r\r-------------------------------\r\r'

      function toHexString(byteArray) {
        return Array.from(byteArray, function(byte) {
          return ('0' + (byte & 0xFF).toString(16)).slice(-2);
        }).join('')
      }

      async function generateRedemptionCode(event) {
        event.preventDefault()
        $redemptionCode.style.display = 'none'
        const formData = new FormData($identificationForm)

        const tokenId = formData.get('tokenId')

        const nonce = new Uint8Array(32)
        crypto.getRandomValues(nonce)
        const redemptionCodePojo = {
          nonce: nonce
        }
        fields.forEach((field) => {
          redemptionCodePojo[field] = formData.get(field)
        })
        redemptionCodePojo['birthYearAscii'] = zeroPadAscii(redemptionCodePojo['birthYearAscii'], 4)
        redemptionCodePojo['birthMonthAscii'] = zeroPadAscii(redemptionCodePojo['birthMonthAscii'], 2)
        redemptionCodePojo['birthDayAscii'] = zeroPadAscii(redemptionCodePojo['birthDayAscii'], 2)

        const redemptionCodeEncoding = redeemer.getRedemptionCodeEncoding(redemptionCodePojo)
        const redemptionCodeHash = new Uint8Array(await crypto.subtle.digest('SHA-256', redemptionCodeEncoding))

        const redemptionCodeEncodingBase2048English = base2048.english.encode(redemptionCodeEncoding)
        const redemptionCodeEncodingHex = toHexString(redemptionCodeEncoding)
        const redemptionCodeHashHex = toHexString(redemptionCodeHash)
        const nonceHex = toHexString(nonce)

        const idPojo = {
        }
        fields.forEach((field) => {
          idPojo[field] = redemptionCodePojo[field]
        })

        const redemptionCodeJson = JSON.stringify({
          'version': "0",
          'tokenId': tokenId,
          'id': idPojo,
          redemptionCodeEncodingBase2048English,
          nonceHex,
          redemptionCodeEncodingHex,
          redemptionCodeHashHex
        }, null, 2)
          //   'REDEMPTION CODE ENCODING BASE2048:\r'
          // + redemptionCodeEncodingBase2048
          // + divider
          // + 'REDMPTION CODE NONCE BASE2048:\r'
          // + redemptionCodeNonceBase2048
          // + divider
          // + 'REDMPTION CODE HASH BASE2048:\r'
          // + redemptionCodeHashBase2048

        const epoch = Math.floor(((new Date).getTime())/ 1000)
        const fileName = `gc-${tokenId}-${epoch}.gc.json.txt`

        $fileName.innerText = fileName
        $redemptionCodeTxt.innerText = redemptionCodeJson

        $redemptionCodeTxtDownload.download = fileName
        $redemptionCodeTxtDownload.href= `data:text/plain;charset=utf-8,${redemptionCodeJson}`

        $redemptionCode.style.display = 'block'

        console.log(redeemer.getRedemptionCodeEncoding(redemptionCodePojo))
      }
    </script>
    <script type="module" src="./app.js"></script>
  </body>
</html>
